{% extends '../base/Admin_base.html' %}
{% load static %}

{% block content %}
<head>
    <title>Election Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<main class="main-container">
    <div class="main-title">
    <h2> Voting Results Tally</h2>
    </div>
    {% for data in chart_data %}
    <div class="chart-container">
    <h3>{{ data.position }}</h3>
    <canvas id="votesChart-{{ forloop.counter }}" width="50" height="50"></canvas>
    </div>
    {% empty %}
    <p>No positions available.</p>
    {% endfor %}

<script id="chart-data" type="application/json">{{ chart_data|safe }}</script>

  
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
    const chartDataElement = document.getElementById('chart-data');
    if (!chartDataElement) {
        console.error('No chart data element found');
        return;
    }

    const chartData = JSON.parse(chartDataElement.textContent);
    console.log('Parsed chartData:', chartData);

    if (!Array.isArray(chartData)) {
        console.error('chartData is not an array:', chartData);
        return;
    }

    if (chartData.length === 0) {
        console.log('No positions data to display the chart.');
        return;
    }

    // Log the number of charts to be rendered
    console.log(`Rendering ${chartData.length} charts.`);
    
    // Log the total number of canvas elements
    const canvasElements = document.querySelectorAll('.chart-container canvas');
    console.log(`Total number of canvas elements in the DOM: ${canvasElements.length}`);
  
    console.log('chartData just before rendering charts:', chartData);
    chartData.forEach((positionData, index) => {
        // Log the position for which the chart is being rendered
        console.log(`Rendering chart for position: ${positionData.position}`);

        const canvasId = `votesChart-${index + 1}`;
        // Log the ID of the canvas being targeted
        console.log(`Looking for canvas with ID: ${canvasId}`);

        const canvasElement = document.getElementById(canvasId);
        if (!canvasElement) {
            console.error(`Canvas element not found: ${canvasId}`);
            return;
        }
        // Confirm that the canvas element was found
        console.log(`Found canvas element for ID ${canvasId}`);
        console.log('Canvas ID being processed:', canvasId);
        const ctx = canvasElement.getContext('2d');
        if (!ctx) {
            console.error(`Failed to get context for canvas ID ${canvasId}`);
            return;
        }

        // Log the data for each position
        const data = positionData.candidates && positionData.candidates.length > 0 
                     ? positionData.candidates.map(c => c.votes) 
                     : [0];
        // Log the labels for each position
        const labels = positionData.candidates && positionData.candidates.length > 0 
                       ? positionData.candidates.map(c => c.name) 
                       : ['No Candidates'];

        console.log(`Data for ${positionData.position}:`, data);
        console.log(`Labels for ${positionData.position}:`, labels);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `${positionData.position} Votes`,
                    data: data,
                    backgroundColor: 'rgba(0, 123, 255, 0.5)'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: `${positionData.position} Votes`
                }
            }
        });
    });
});
    </script>
</main>
</body>
{% endblock %}